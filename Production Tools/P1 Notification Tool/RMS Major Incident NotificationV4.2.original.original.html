<!DOCTYPE html>
<!-- saved from url=(0125)file:///C:/Users/nishenh/AppData/Local/Microsoft/Windows/INetCache/Content.Outlook/92D91QRY/RMS_P1_Incident_TemplateV2.0.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMS Major Incident Notification v4.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #003d7a;
            --secondary-color: #424242;
            --border-color: #e0e0e0;
            --header-bg: linear-gradient(135deg, #003d7a 0%, #0066CC 100%);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            color: #333;
            line-height: 1.6;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        
        .editable {
            border: 1px solid transparent;
            padding: 4px;
            min-height: 20px;
        }
        
        .editable:hover {
            border: 1px dashed #ccc;
            background-color: #f9f9f9;
        }
        
        .header {
            background: var(--header-bg);
            color: white;
            padding: 25px;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 120px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .company-logo {
            width: 350px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 30px;
        }
        
        .company-logo svg {
            width: 100%;
            height: auto;
            max-height: 100%;
        }
        
        .date-container {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-size: 16px;
        }
        
        .title-bar {
            background-color: var(--primary-color);
            color: white;
            padding: 18px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .basic-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            border-bottom: 1px solid var(--border-color);
        }
        
        .info-cell {
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            padding: 12px;
            display: flex;
        }
        
        .info-cell:last-child {
            border-right: none;
        }
        
        .info-label {
            font-weight: bold;
            width: 180px;
            color: var(--secondary-color);
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            min-height: 300px;
        }
        
        .content-section {
            border-right: 1px solid var(--border-color);
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        .content-section:last-child {
            border-right: none;
        }
        
        .section-header {
            background-color: var(--primary-color);
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
        }
        
        .section-content {
            padding: 15px;
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .timeline-item {
            display: grid;
            grid-template-columns: 80px 1fr;
            margin-bottom: 10px;
            position: relative;
        }
        
        .timeline-item::after {
            content: '';
            position: absolute;
            left: 40px;
            top: 24px;
            height: calc(100% + 10px);
            width: 2px;
            background-color: #e0e0e0;
            z-index: 1;
        }
        
        .timeline-item:last-child::after {
            display: none;
        }
        
        .timeline-time {
            font-weight: bold;
            color: var(--secondary-color);
            position: relative;
            z-index: 2;
        }
        
        .timeline-time::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 8px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--primary-color);
            z-index: 2;
        }
        
        .timeline-content {
            background-color: #f5f5f5;
            padding: 8px 12px;
            border-radius: 4px;
            position: relative;
            z-index: 2;
        }
        
        .buttons-container {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 15px;
            background-color: #f9f9f9;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
        }
        
        .action-button {
            padding: 10px 18px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .action-button:hover {
            background-color: #002a5c;
            transform: translateY(-1px);
        }
        
        .secondary-button {
            background-color: #757575;
        }
        
        .secondary-button:hover {
            background-color: #616161;
        }
        
        .save-button {
            background-color: #4caf50;
        }
        
        .save-button:hover {
            background-color: #388e3c;
        }
        
        .load-button {
            background-color: #ff9800;
        }
        
        .load-button:hover {
            background-color: #f57c00;
        }
        
        .control-panel {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .edit-toggle {
            background-color: #4caf50;
            padding: 12px 20px;
        }
        
        .edit-toggle:hover {
            background-color: #388e3c;
        }
        
        .edit-active {
            outline: 2px dashed #4caf50;
        }
        
        .add-timeline-form {
            margin-top: 15px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 6px;
            display: none;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 12px;
            color: var(--secondary-color);
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .add-button {
            background-color: #4caf50;
            margin-top: 10px;
        }
        
        .add-button:hover {
            background-color: #388e3c;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            background-color: #f8f9fa;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
            position: relative;
        }
        
        .tab:hover {
            background-color: #e9ecef;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary-color);
            font-weight: bold;
            background-color: white;
            color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .chart-wrapper {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            color: var(--secondary-color);
        }
        
        .risk-indicators {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .risk-indicator {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            border-radius: 8px;
            color: white;
            text-align: center;
            font-weight: bold;
        }
        
        .risk-high {
            background-color: #f44336;
        }
        
        .risk-medium {
            background-color: #ff9800;
        }
        
        .risk-low {
            background-color: #4caf50;
        }
        
        .metrics-row {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .metric-card {
            flex: 1;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
            color: var(--primary-color);
        }
        
        .metric-label {
            color: var(--secondary-color);
            font-size: 14px;
            font-weight: 500;
        }
        
        .recommendations {
            margin-top: 20px;
        }
        
        .recommendation-item {
            margin-bottom: 15px;
            padding: 20px;
            background-color: #f9f9f9;
            border-left: 4px solid var(--primary-color);
            border-radius: 0 8px 8px 0;
        }
        
        .recommendation-item h4 {
            margin-bottom: 8px;
            color: var(--secondary-color);
            font-size: 16px;
        }

        .hidden-input {
            display: none;
        }

        .status-indicator {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 8px;
        }

        .status-saved {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        .status-modified {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        /* Developer Credits - Fine Print */
        .developer-credits {
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
            padding: 8px 20px;
            text-align: center;
        }
        
        .developer-credits p {
            font-size: 10px;
            color: #6c757d;
            margin: 0;
            font-style: italic;
        }
        
        @media print {
            .buttons-container, .control-panel, .add-timeline-form, .developer-credits {
                display: none !important;
            }
            
            .container {
                box-shadow: none;
                max-width: 100%;
            }
            
            body {
                background-color: white;
            }
            
            .editable {
                border: none !important;
            }
            
            .editable:hover {
                border: none !important;
                background-color: transparent !important;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="incident-template">
        <div class="header">
            <div class="logo-container">
                <div class="company-logo">
                    <!-- First Technology KZN Logo v4.2 - Clean Thin Text (Readable) -->
                    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 350 80" preserveAspectRatio="xMidYMid meet">
                        <!-- Geometric Design Element -->
                        <defs>
                            <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#FFFFFF;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#E8E8E8;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        
                        <!-- Triangular/Geometric Design -->
                        <polygon points="10,20 50,20 35,35 20,50 10,35" fill="url(#logoGradient)" stroke="#FFFFFF" stroke-width="1"/>
                        <polygon points="35,35 50,20 65,30 55,45 35,35" fill="#FFFFFF" opacity="0.9"/>
                        
                        <!-- Main Company Text - Thin and Readable -->
                        <text x="80" y="35" font-family="Arial, Helvetica, sans-serif" font-size="24" font-weight="300" fill="#FFFFFF" letter-spacing="0.5px">First Technology</text>
                        
                        <!-- Subtitle Text - Readable -->
                        <text x="80" y="55" font-family="Arial, Helvetica, sans-serif" font-size="11" font-weight="300" fill="#FFFFFF" opacity="0.9">KwaZulu-Natal (PTY) LTD</text>
                        
                        <!-- Professional Accent Line -->
                        <line x1="80" y1="42" x2="280" y2="42" stroke="#FFFFFF" stroke-width="1" opacity="0.7"/>
                    </svg>
                </div>
            </div>
            <div class="date-container">
                <div><strong>Date:</strong></div>
                <div class="editable" contenteditable="false" id="incident-date">Wednesday 02 July 2025</div>
                <span class="status-indicator" id="save-status" style="display: none;"></span>
            </div>
        </div>
        
        <div class="title-bar">
            <div class="editable" contenteditable="false">RMS MAJOR INCIDENT NOTIFICATION</div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="main-tab">Incident Details</div>
            <div class="tab" data-tab="analysis-tab">Analysis &amp; Metrics</div>
            <div class="tab" data-tab="recommendations-tab">Recommendations</div>
        </div>
        
        <div id="main-tab" class="tab-content active">
            <div class="basic-info">
                <div class="info-cell">
                    <div class="info-label">Customer:</div>
                    <div class="editable" contenteditable="false" id="customer-name">ABC Corporation</div>
                </div>
                <div class="info-cell">
                    <div class="info-label">Site:</div>
                    <div class="editable" contenteditable="false" id="site-location">Durban Head Office</div>
                </div>
            </div>
            
            <div class="basic-info">
                <div class="info-cell">
                    <div class="info-label">Incident Number:</div>
                    <div class="editable" contenteditable="false" id="incident-number">INC-2025-001</div>
                </div>
                <div class="info-cell">
                    <div class="info-label">Incident status:</div>
                    <div class="editable" contenteditable="false" id="incident-status">INVESTIGATING</div>
                </div>
                <div class="info-cell">
                    <div class="info-label">Start Time:</div>
                    <div class="editable" contenteditable="false" id="start-time">08:30 AM</div>
                </div>
            </div>
            
            <div class="basic-info">
                <div class="info-cell">
                    <div class="info-label">Incident Manager:</div>
                    <div class="editable" contenteditable="false" id="incident-manager">John Smith</div>
                </div>
                <div class="info-cell">
                    <div class="info-label">Incident Priority:</div>
                    <div class="editable" contenteditable="false" id="incident-priority">HIGH</div>
                </div>
                <div class="info-cell">
                    <div class="info-label">Next Update Time:</div>
                    <div class="editable" contenteditable="false" id="next-update-time">10:00 AM</div>
                </div>
            </div>
            
            <div class="basic-info">
                <div class="info-cell">
                    <div class="info-label">Lead Engineer:</div>
                    <div class="editable" contenteditable="false" id="lead-engineer">Sarah Johnson</div>
                </div>
                <div class="info-cell">
                    <div class="info-label">Communication platform:</div>
                    <div class="editable" contenteditable="false" id="communication-platform">Microsoft Teams</div>
                </div>
                <div class="info-cell">
                    <div class="info-label">Is a Workaround in place?</div>
                    <div class="editable" contenteditable="false" id="workaround-status">YES</div>
                </div>
            </div>
            
            <div class="content-grid">
                <div class="content-section">
                    <div class="section-header">INCIDENT DETAILS</div>
                    <div class="section-content">
                        <div class="editable" contenteditable="false" id="incident-details">Network connectivity issues affecting multiple floors in the main building. Users experiencing intermittent connection drops and slow response times.</div>
                    </div>
                </div>
                <div class="content-section">
                    <div class="section-header">BUSINESS IMPACT</div>
                    <div class="section-content">
                        <div class="editable" contenteditable="false" id="business-impact">Approximately 150 users affected. Critical business applications experiencing degraded performance. Customer service operations partially impacted.</div>
                    </div>
                </div>
                <div class="content-section">
                    <div class="section-header">INCIDENT TIMELINE</div>
                    <div class="section-content" id="timeline-container">
                        <!-- Timeline entries will be added dynamically -->
                    <div class="timeline-item">
                    <div class="timeline-time">08:30</div>
                    <div class="timeline-content">First reports of network issues received via helpdesk</div>
                </div><div class="timeline-item">
                    <div class="timeline-time">08:35</div>
                    <div class="timeline-content">Incident escalated to Level 2 support team</div>
                </div><div class="timeline-item">
                    <div class="timeline-time">08:45</div>
                    <div class="timeline-content">Network team investigating core switch issues</div>
                </div><div class="timeline-item">
                    <div class="timeline-time">09:00</div>
                    <div class="timeline-content">Backup connection activated as temporary workaround</div>
                </div></div>
                    <div class="add-timeline-form" id="add-timeline-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="timeline-time">Time</label>
                                <input type="text" id="timeline-time" placeholder="e.g., 09:15">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="timeline-content">Event Description</label>
                                <textarea id="timeline-content" placeholder="Describe the event..."></textarea>
                            </div>
                        </div>
                        <button class="action-button add-button" onclick="addTimelineEntry()">Add Entry</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="analysis-tab" class="tab-content">
            <h3>Incident Analysis</h3>
            <div class="editable" contenteditable="false" id="incident-analysis">
                Enter incident analysis and root cause information here...
            </div>
            
            <div class="metrics-row">
                <div class="metric-card">
                    <div class="metric-label">Time to Detection</div>
                    <div class="metric-value editable" contenteditable="false" id="detection-time">12 min</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Time to Resolution</div>
                    <div class="metric-value editable" contenteditable="false" id="resolution-time">1h 42m</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Affected Systems</div>
                    <div class="metric-value editable" contenteditable="false" id="affected-systems">3</div>
                </div>
            </div>
            
            <div class="risk-indicators">
                <div class="risk-indicator risk-high">
                    <div>Business Risk</div>
                    <div class="editable" contenteditable="false" id="business-risk">HIGH</div>
                </div>
                <div class="risk-indicator risk-medium">
                    <div>Technical Risk</div>
                    <div class="editable" contenteditable="false" id="technical-risk">MEDIUM</div>
                </div>
                <div class="risk-indicator risk-low">
                    <div>Security Risk</div>
                    <div class="editable" contenteditable="false" id="security-risk">LOW</div>
                </div>
            </div>
            
            <div class="charts-container">
                <div class="chart-wrapper">
                    <div class="chart-title">Impact Distribution</div>
                    <canvas id="impactChart" height="0" style="display: block; box-sizing: border-box; height: 0px; width: 0px;" width="0"></canvas>
                </div>
                <div class="chart-wrapper">
                    <div class="chart-title">System Availability</div>
                    <canvas id="availabilityChart" height="0" style="display: block; box-sizing: border-box; height: 0px; width: 0px;" width="0"></canvas>
                </div>
            </div>
        </div>
        
        <div id="recommendations-tab" class="tab-content">
            <h3>Recommendations</h3>
            <div class="recommendations" id="recommendations-container">
                <div class="recommendation-item">
                    <h4>Immediate Actions</h4>
                    <div class="editable" contenteditable="false" id="immediate-actions">
                        List immediate actions to be taken...
                    </div>
                </div>
                <div class="recommendation-item">
                    <h4>Short-term Recommendations</h4>
                    <div class="editable" contenteditable="false" id="short-term-recs">
                        List short-term recommendations...
                    </div>
                </div>
                <div class="recommendation-item">
                    <h4>Long-term Recommendations</h4>
                    <div class="editable" contenteditable="false" id="long-term-recs">
                        List long-term recommendations...
                    </div>
                </div>
            </div>
        </div>
        
        <div class="buttons-container">
            <button class="action-button save-button" onclick="saveReport()">
                <span>💾 Save Report</span>
            </button>
            <button class="action-button load-button" onclick="loadReport()">
                <span>📂 Load Report</span>
            </button>
            <button class="action-button" onclick="toggleTimelineForm()">
                <span>➕ Add Timeline Entry</span>
            </button>
            <button class="action-button secondary-button" onclick="clearTemplate()">
                <span>🗑️ Clear Template</span>
            </button>
            <button class="action-button" onclick="exportToPDF()">
                <span>📄 Export to PDF</span>
            </button>
            <button class="action-button" onclick="exportToHTML()">
                <span>🌐 Export to HTML</span>
            </button>
            <button class="action-button" onclick="sendEmailWithAttachment()">
                <span>📧 Send Email with PDF</span>
            </button>
        </div>
        
        <!-- Developer Credits - Hidden on Export -->
        <div class="developer-credits" id="developer-credits">
            <p>RMS Major Incident Notification v4.2 - Created by: Nishen Harichunder RMS nishenh@ftechkzn.co.za</p>
        </div>
    </div>
    
    <div class="control-panel">
        <button class="action-button edit-toggle" onclick="toggleEditMode()">
            <span id="edit-button-text">🔓 Enable Edit Mode</span>
        </button>
    </div>

    <input type="file" id="file-input" class="hidden-input" accept=".json" onchange="handleFileLoad(event)">
    
    <script>
        // Global variables
        let reportModified = false;
        let currentFilename = '';
        let impactChart, availabilityChart;
        let editMode = false;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            
            // Set current date
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-GB', { 
                weekday: 'long',
                day: '2-digit', 
                month: 'long', 
                year: 'numeric'
            });
            document.getElementById('incident-date').textContent = dateStr;
            
            // Initialize tab functionality
            initializeTabs();
            
            // Initialize sample data
            initializeSampleData();
            
            // Initialize charts
            initializeCharts();

            // Setup change tracking
            setupChangeTracking();
            
            console.log('Initialization complete');
        });
        
        // Initialize tab functionality
        function initializeTabs() {
            console.log('Initializing tabs...');
            const tabs = document.querySelectorAll('.tab');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    console.log('Tab clicked:', this.dataset.tab);
                    switchTab(this, this.dataset.tab);
                });
            });
        }
        
        // Tab switching functionality
        function switchTab(tabElement, contentId) {
            console.log('Switching to tab:', contentId);
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Add active class to clicked tab
            tabElement.classList.add('active');
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab content
            const targetContent = document.getElementById(contentId);
            if (targetContent) {
                targetContent.classList.add('active');
                console.log('Tab switched successfully to:', contentId);
            } else {
                console.error('Target content not found:', contentId);
            }
        }
        
        // Setup change tracking
        function setupChangeTracking() {
            const editables = document.querySelectorAll('.editable');
            editables.forEach(el => {
                el.addEventListener('input', () => {
                    reportModified = true;
                    updateSaveStatus('modified');
                });
            });
        }
        
        // Update save status indicator
        function updateSaveStatus(status) {
            const indicator = document.getElementById('save-status');
            indicator.style.display = 'inline-block';
            
            if (status === 'saved') {
                indicator.textContent = 'Saved';
                indicator.className = 'status-indicator status-saved';
                reportModified = false;
            } else if (status === 'modified') {
                indicator.textContent = 'Modified';
                indicator.className = 'status-indicator status-modified';
            }
        }
        
        // Generate filename
        function generateFilename() {
            const customer = document.getElementById('customer-name').textContent.trim() || 'Unknown';
            const incidentNo = document.getElementById('incident-number').textContent.trim() || 'No-Number';
            const date = new Date().toISOString().split('T')[0];
            
            const cleanCustomer = customer.replace(/[^a-z0-9]/gi, '_');
            const cleanIncident = incidentNo.replace(/[^a-z0-9]/gi, '_');
            
            return `${cleanCustomer}_${cleanIncident}_${date}`;
        }
        
        // Edit mode toggle
        function toggleEditMode() {
            editMode = !editMode;
            const editables = document.querySelectorAll('.editable');
            const buttonText = document.getElementById('edit-button-text');
            
            editables.forEach(el => {
                el.contentEditable = editMode;
                if (editMode) {
                    el.classList.add('edit-active');
                } else {
                    el.classList.remove('edit-active');
                }
            });
            
            buttonText.innerHTML = editMode ? '🔒 Disable Edit Mode' : '🔓 Enable Edit Mode';
        }
        
        // Timeline functionality
        function toggleTimelineForm() {
            const form = document.getElementById('add-timeline-form');
            form.style.display = form.style.display === 'block' ? 'none' : 'block';
        }
        
        function addTimelineEntry() {
            const time = document.getElementById('timeline-time').value;
            const content = document.getElementById('timeline-content').value;
            
            if (!time || !content) {
                alert('Please fill in both time and description fields.');
                return;
            }
            
            const container = document.getElementById('timeline-container');
            const timelineItem = document.createElement('div');
            timelineItem.className = 'timeline-item';
            timelineItem.innerHTML = `
                <div class="timeline-time">${time}</div>
                <div class="timeline-content">${content}</div>
            `;
            
            container.appendChild(timelineItem);
            
            // Clear form fields
            document.getElementById('timeline-time').value = '';
            document.getElementById('timeline-content').value = '';
            
            // Hide form
            document.getElementById('add-timeline-form').style.display = 'none';
            
            // Mark as modified
            reportModified = true;
            updateSaveStatus('modified');
        }
        
        // Save report function
        function saveReport() {
            const reportData = {
                metadata: {
                    saveDate: new Date().toISOString(),
                    version: '1.0'
                },
                basicInfo: {
                    customerName: document.getElementById('customer-name').textContent,
                    siteLocation: document.getElementById('site-location').textContent,
                    incidentNumber: document.getElementById('incident-number').textContent,
                    incidentStatus: document.getElementById('incident-status').textContent,
                    startTime: document.getElementById('start-time').textContent,
                    incidentManager: document.getElementById('incident-manager').textContent,
                    incidentPriority: document.getElementById('incident-priority').textContent,
                    nextUpdateTime: document.getElementById('next-update-time').textContent,
                    leadEngineer: document.getElementById('lead-engineer').textContent,
                    communicationPlatform: document.getElementById('communication-platform').textContent,
                    workaroundStatus: document.getElementById('workaround-status').textContent
                },
                content: {
                    incidentDetails: document.getElementById('incident-details').textContent,
                    businessImpact: document.getElementById('business-impact').textContent,
                    timeline: Array.from(document.querySelectorAll('.timeline-item')).map(item => ({
                        time: item.querySelector('.timeline-time').textContent,
                        content: item.querySelector('.timeline-content').textContent
                    }))
                },
                analysis: {
                    incidentAnalysis: document.getElementById('incident-analysis').textContent,
                    detectionTime: document.getElementById('detection-time').textContent,
                    resolutionTime: document.getElementById('resolution-time').textContent,
                    affectedSystems: document.getElementById('affected-systems').textContent,
                    businessRisk: document.getElementById('business-risk').textContent,
                    technicalRisk: document.getElementById('technical-risk').textContent,
                    securityRisk: document.getElementById('security-risk').textContent
                },
                recommendations: {
                    immediateActions: document.getElementById('immediate-actions').textContent,
                    shortTermRecs: document.getElementById('short-term-recs').textContent,
                    longTermRecs: document.getElementById('long-term-recs').textContent
                }
            };
            
            const filename = generateFilename();
            currentFilename = filename;
            
            const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            updateSaveStatus('saved');
            alert(`Report saved as: ${filename}.json`);
        }
        
        // Load report function
        function loadReport() {
            if (reportModified) {
                if (!confirm('You have unsaved changes. Do you want to continue loading a new report?')) {
                    return;
                }
            }
            document.getElementById('file-input').click();
        }
        
        // Handle file load
        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                alert('Please select a valid JSON report file.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const reportData = JSON.parse(e.target.result);
                    loadReportData(reportData);
                    currentFilename = file.name.replace('.json', '');
                    updateSaveStatus('saved');
                    alert('Report loaded successfully!');
                } catch (error) {
                    alert('Error loading report: Invalid file format.');
                    console.error('Load error:', error);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }
        
        // Load report data into the form
        function loadReportData(data) {
            // Load basic info
            if (data.basicInfo) {
                document.getElementById('customer-name').textContent = data.basicInfo.customerName || '';
                document.getElementById('site-location').textContent = data.basicInfo.siteLocation || '';
                document.getElementById('incident-number').textContent = data.basicInfo.incidentNumber || '';
                document.getElementById('incident-status').textContent = data.basicInfo.incidentStatus || '';
                document.getElementById('start-time').textContent = data.basicInfo.startTime || '';
                document.getElementById('incident-manager').textContent = data.basicInfo.incidentManager || '';
                document.getElementById('incident-priority').textContent = data.basicInfo.incidentPriority || '';
                document.getElementById('next-update-time').textContent = data.basicInfo.nextUpdateTime || '';
                document.getElementById('lead-engineer').textContent = data.basicInfo.leadEngineer || '';
                document.getElementById('communication-platform').textContent = data.basicInfo.communicationPlatform || '';
                document.getElementById('workaround-status').textContent = data.basicInfo.workaroundStatus || '';
            }
            
            // Load content
            if (data.content) {
                document.getElementById('incident-details').textContent = data.content.incidentDetails || '';
                document.getElementById('business-impact').textContent = data.content.businessImpact || '';
                
                // Load timeline
                const timelineContainer = document.getElementById('timeline-container');
                timelineContainer.innerHTML = '';
                if (data.content.timeline && Array.isArray(data.content.timeline)) {
                    data.content.timeline.forEach(item => {
                        const timelineItem = document.createElement('div');
                        timelineItem.className = 'timeline-item';
                        timelineItem.innerHTML = `
                            <div class="timeline-time">${item.time}</div>
                            <div class="timeline-content">${item.content}</div>
                        `;
                        timelineContainer.appendChild(timelineItem);
                    });
                }
            }
            
            // Load analysis
            if (data.analysis) {
                document.getElementById('incident-analysis').textContent = data.analysis.incidentAnalysis || '';
                document.getElementById('detection-time').textContent = data.analysis.detectionTime || '';
                document.getElementById('resolution-time').textContent = data.analysis.resolutionTime || '';
                document.getElementById('affected-systems').textContent = data.analysis.affectedSystems || '';
                document.getElementById('business-risk').textContent = data.analysis.businessRisk || '';
                document.getElementById('technical-risk').textContent = data.analysis.technicalRisk || '';
                document.getElementById('security-risk').textContent = data.analysis.securityRisk || '';
            }
            
            // Load recommendations
            if (data.recommendations) {
                document.getElementById('immediate-actions').textContent = data.recommendations.immediateActions || '';
                document.getElementById('short-term-recs').textContent = data.recommendations.shortTermRecs || '';
                document.getElementById('long-term-recs').textContent = data.recommendations.longTermRecs || '';
            }
        }
        
        // Enhanced send email function with PDF attachment
        function sendEmailWithAttachment() {
            generatePDFForEmail().then(pdfBlob => {
                const customer = document.getElementById('customer-name').textContent || 'Unknown Customer';
                const incidentNo = document.getElementById('incident-number').textContent || 'Unknown';
                const incidentStatus = document.getElementById('incident-status').textContent || 'Unknown';
                const startTime = document.getElementById('start-time').textContent || 'Unknown';
                const incidentDetails = document.getElementById('incident-details').textContent || 'No details provided';
                const businessImpact = document.getElementById('business-impact').textContent || 'No impact details provided';
                
                const subject = `MAJOR INCIDENT NOTIFICATION - ${customer} - ${incidentNo}`;
                
                const body = `Dear Team,

Please find attached the Major Incident Notification report for your immediate attention.

INCIDENT SUMMARY:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Customer: ${customer}
Incident Number: ${incidentNo}
Current Status: ${incidentStatus}
Start Time: ${startTime}

INCIDENT DETAILS:
${incidentDetails}

BUSINESS IMPACT:
${businessImpact}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

The complete incident report is attached as a PDF document containing:
• Detailed incident timeline
• Technical analysis and metrics
• Risk assessment
• Recommendations for resolution

Please review the attached report and contact the incident manager for any questions or updates.

This is an automated notification from the RMS Incident Management System.

Best regards,
First Technology - KwaZulu-Natal (PTY) LTD
Incident Management Team`;

                // Fallback to mailto with instructions
                const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.open(mailtoLink);
                
                // Show instructions for manual attachment
                setTimeout(() => {
                    alert(`Email opened in your default mail client.

IMPORTANT: Please attach the PDF report manually:
1. The PDF will be automatically downloaded
2. Attach the downloaded PDF to your email before sending

Click OK to download the PDF report now.`);
                    
                    // Download the PDF for manual attachment
                    const filename = `${generateFilename()}_Report.pdf`;
                    const url = URL.createObjectURL(pdfBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 1000);
            }).catch(error => {
                console.error('Error generating PDF for email:', error);
                alert('Error generating PDF attachment. Please try exporting to PDF manually.');
            });
        }
        
        // Generate PDF specifically for email attachment
        function generatePDFForEmail() {
            return new Promise((resolve, reject) => {
                const { jsPDF } = window.jspdf;
                
                // Hide buttons and developer credits before export
                const buttonsContainer = document.querySelector('.buttons-container');
                const controlPanel = document.querySelector('.control-panel');
                const addTimelineForm = document.querySelector('.add-timeline-form');
                const developerCredits = document.querySelector('.developer-credits');
                
                buttonsContainer.style.display = 'none';
                controlPanel.style.display = 'none';
                addTimelineForm.style.display = 'none';
                developerCredits.style.display = 'none';
                
                // Remove edit-active class
                document.querySelectorAll('.edit-active').forEach(el => {
                    el.classList.remove('edit-active');
                });
                
                const template = document.getElementById('incident-template');
                
                html2canvas(template, { 
                    scale: 2,
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const canvasRatio = canvas.height / canvas.width;
                    const imgWidth = pdfWidth;
                    const imgHeight = pdfWidth * canvasRatio;
                    
                    let heightLeft = imgHeight;
                    let position = 0;
                    
                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pdfHeight;
                    
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pdfHeight;
                    }
                    
                    // Restore buttons and credits after export
                    buttonsContainer.style.display = 'flex';
                    controlPanel.style.display = 'flex';
                    developerCredits.style.display = 'block';
                    
                    // Return PDF as blob
                    const pdfBlob = pdf.output('blob');
                    resolve(pdfBlob);
                }).catch(error => {
                    // Restore buttons and credits on error
                    buttonsContainer.style.display = 'flex';
                    controlPanel.style.display = 'flex';
                    developerCredits.style.display = 'block';
                    reject(error);
                });
            });
        }
        
        // Export functionalities
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            
            // Hide buttons and developer credits before export
            const buttonsContainer = document.querySelector('.buttons-container');
            const controlPanel = document.querySelector('.control-panel');
            const addTimelineForm = document.querySelector('.add-timeline-form');
            const developerCredits = document.querySelector('.developer-credits');
            
            buttonsContainer.style.display = 'none';
            controlPanel.style.display = 'none';
            addTimelineForm.style.display = 'none';
            developerCredits.style.display = 'none';
            
            // Remove edit-active class
            document.querySelectorAll('.edit-active').forEach(el => {
                el.classList.remove('edit-active');
            });
            
            const template = document.getElementById('incident-template');
            
            html2canvas(template, { 
                scale: 2,
                useCORS: true,
                logging: false
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const canvasRatio = canvas.height / canvas.width;
                const imgWidth = pdfWidth;
                const imgHeight = pdfWidth * canvasRatio;
                
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pdfHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pdfHeight;
                }
                
                const filename = `${generateFilename()}_Report.pdf`;
                pdf.save(filename);
                
                // Restore buttons and credits after export
                buttonsContainer.style.display = 'flex';
                controlPanel.style.display = 'flex';
                developerCredits.style.display = 'block';
            });
        }
        
        function exportToHTML() {
            const template = document.getElementById('incident-template');
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = template.outerHTML;
            
            // Remove control elements AND developer credits
            const controlElements = tempDiv.querySelectorAll('.buttons-container, .control-panel, .add-timeline-form, .developer-credits');
            controlElements.forEach(el => el.remove());
            
            // Remove edit-active class
            const editActives = tempDiv.querySelectorAll('.edit-active');
            editActives.forEach(el => el.classList.remove('edit-active'));
            
            // Make all editable elements non-editable for the export
            const editables = tempDiv.querySelectorAll('.editable');
            editables.forEach(el => {
                el.contentEditable = false;
            });
            
            // Create a blob and download
            const htmlContent = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <title>Incident Report - ${document.getElementById('incident-number').textContent}</title>
                    <style>
                    ${document.querySelector('style').innerHTML}
                    </style>
                </head>
                <body>
                    ${tempDiv.innerHTML}
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${generateFilename()}_Report.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Clear the template
        function clearTemplate() {
            if (confirm('Are you sure you want to clear all data from the template?')) {
                // Clear basic info
                document.getElementById('customer-name').textContent = '';
                document.getElementById('site-location').textContent = '';
                document.getElementById('incident-number').textContent = '';
                document.getElementById('incident-status').textContent = '';
                document.getElementById('start-time').textContent = '';
                document.getElementById('incident-manager').textContent = '';
                document.getElementById('incident-priority').textContent = '';
                document.getElementById('next-update-time').textContent = '';
                document.getElementById('lead-engineer').textContent = '';
                document.getElementById('communication-platform').textContent = '';
                document.getElementById('workaround-status').textContent = '';
                
                // Clear detailed sections
                document.getElementById('incident-details').textContent = '';
                document.getElementById('business-impact').textContent = '';
                
                // Clear metrics
                document.getElementById('detection-time').textContent = '';
                document.getElementById('resolution-time').textContent = '';
                document.getElementById('affected-systems').textContent = '';
                
                // Clear risk indicators
                document.getElementById('business-risk').textContent = '';
                document.getElementById('technical-risk').textContent = '';
                document.getElementById('security-risk').textContent = '';
                
                // Clear analysis and recommendations
                document.getElementById('incident-analysis').textContent = '';
                document.getElementById('immediate-actions').textContent = '';
                document.getElementById('short-term-recs').textContent = '';
                document.getElementById('long-term-recs').textContent = '';
                
                // Clear timeline entries
                document.getElementById('timeline-container').innerHTML = '';
                
                // Reset save status
                currentFilename = '';
                reportModified = false;
                document.getElementById('save-status').style.display = 'none';
                
                // Re-initialize charts with empty data
                reinitializeEmptyCharts();
            }
        }
        
        // Initialize sample data (remove in production)
        function initializeSampleData() {
            document.getElementById('customer-name').textContent = 'ABC Corporation';
            document.getElementById('site-location').textContent = 'Durban Head Office';
            document.getElementById('incident-number').textContent = 'INC-2025-001';
            document.getElementById('incident-status').textContent = 'INVESTIGATING';
            document.getElementById('start-time').textContent = '08:30 AM';
            document.getElementById('incident-manager').textContent = 'John Smith';
            document.getElementById('incident-priority').textContent = 'HIGH';
            document.getElementById('next-update-time').textContent = '10:00 AM';
            document.getElementById('lead-engineer').textContent = 'Sarah Johnson';
            document.getElementById('communication-platform').textContent = 'Microsoft Teams';
            document.getElementById('workaround-status').textContent = 'YES';
            
            document.getElementById('incident-details').textContent = 'Network connectivity issues affecting multiple floors in the main building. Users experiencing intermittent connection drops and slow response times.';
            document.getElementById('business-impact').textContent = 'Approximately 150 users affected. Critical business applications experiencing degraded performance. Customer service operations partially impacted.';
            
            // Add sample timeline
            const timelineContainer = document.getElementById('timeline-container');
            const sampleEvents = [
                { time: '08:30', content: 'First reports of network issues received via helpdesk' },
                { time: '08:35', content: 'Incident escalated to Level 2 support team' },
                { time: '08:45', content: 'Network team investigating core switch issues' },
                { time: '09:00', content: 'Backup connection activated as temporary workaround' }
            ];
            
            sampleEvents.forEach(event => {
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item';
                timelineItem.innerHTML = `
                    <div class="timeline-time">${event.time}</div>
                    <div class="timeline-content">${event.content}</div>
                `;
                timelineContainer.appendChild(timelineItem);
            });
        }
        
        // Initialize charts
        function initializeCharts() {
            // Destroy existing charts if they exist
            if (impactChart) {
                impactChart.destroy();
            }
            if (availabilityChart) {
                availabilityChart.destroy();
            }
            
            // Impact Distribution Chart
            const impactCtx = document.getElementById('impactChart').getContext('2d');
            impactChart = new Chart(impactCtx, {
                type: 'pie',
                data: {
                    labels: ['Network', 'Applications', 'Servers', 'Storage', 'Security'],
                    datasets: [{
                        data: [35, 20, 25, 10, 10],
                        backgroundColor: [
                            '#003d7a',
                            '#43a047',
                            '#e53935',
                            '#fb8c00',
                            '#8e24aa'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
            
            // System Availability Chart
            const availabilityCtx = document.getElementById('availabilityChart').getContext('2d');
            availabilityChart = new Chart(availabilityCtx, {
                type: 'bar',
                data: {
                    labels: ['F29', 'F28', 'F33', 'Main Network', 'Applications'],
                    datasets: [{
                        label: 'Availability %',
                        data: [78, 100, 95, 90, 85],
                        backgroundColor: [
                            '#e53935',
                            '#43a047',
                            '#fb8c00',
                            '#003d7a',
                            '#8e24aa'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Availability %'
                            }
                        }
                    }
                }
            });
        }
        
        // Re-initialize charts with empty data
        function reinitializeEmptyCharts() {
            // Destroy existing charts
            if (impactChart) {
                impactChart.destroy();
            }
            if (availabilityChart) {
                availabilityChart.destroy();
            }
            
            // Impact Distribution Chart
            const impactCtx = document.getElementById('impactChart').getContext('2d');
            impactChart = new Chart(impactCtx, {
                type: 'pie',
                data: {
                    labels: ['Category 1', 'Category 2', 'Category 3', 'Category 4', 'Category 5'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            '#003d7a',
                            '#43a047',
                            '#e53935',
                            '#fb8c00',
                            '#8e24aa'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
            
            // System Availability Chart
            const availabilityCtx = document.getElementById('availabilityChart').getContext('2d');
            availabilityChart = new Chart(availabilityCtx, {
                type: 'bar',
                data: {
                    labels: ['System 1', 'System 2', 'System 3', 'System 4', 'System 5'],
                    datasets: [{
                        label: 'Availability %',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            '#e53935',
                            '#43a047',
                            '#fb8c00',
                            '#003d7a',
                            '#8e24aa'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Availability %'
                            }
                        }
                    }
                }
            });
        }
        
    </script>

</body></html>