<!DOCTYPE html>
<html>
<head>
    <title>üõ°Ô∏è BULLETPROOF SYSTEM TEST</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 1000px; margin: 0 auto; }
        .test-section { background: #2a2a2a; padding: 20px; margin: 10px 0; border-radius: 8px; }
        button { background: #00ff00; color: #000; padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .critical { background: #ff073a; color: white; }
        .success { background: #00ff00; color: #000; }
        .test-result { background: #333; color: #fff; border: 1px solid #555; padding: 10px; margin: 10px 0; font-family: monospace; }
        .pass { border-left: 4px solid #00ff00; }
        .fail { border-left: 4px solid #ff073a; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è BULLETPROOF DATA PROTECTION TEST</h1>
        <p><strong>MISSION CRITICAL:</strong> Verify enterprise-grade data protection</p>
        
        <div class="test-section">
            <h2>üß™ PERSISTENCE TESTS</h2>
            <button onclick="testDataPersistence()">üîÑ TEST DATA PERSISTENCE</button>
            <button onclick="testMultipleReloads()">üîÑ TEST MULTIPLE RELOADS</button>
            <button onclick="testStorageFailure()">üí• TEST STORAGE FAILURE RECOVERY</button>
            <div id="persistenceResults"></div>
        </div>

        <div class="test-section">
            <h2>üõ°Ô∏è BULLETPROOF VERIFICATION</h2>
            <button onclick="verifyBulletproofSystem()">üõ°Ô∏è VERIFY BULLETPROOF SYSTEM</button>
            <button onclick="testAutoBackup()">‚è∞ TEST AUTO-BACKUP</button>
            <button onclick="testRecoveryLayers()">üîß TEST RECOVERY LAYERS</button>
            <div id="bulletproofResults"></div>
        </div>

        <div class="test-section">
            <h2>üìä SYSTEM STATUS</h2>
            <button onclick="getSystemStatus()">üìä GET SYSTEM STATUS</button>
            <button onclick="exportTestResults()">üíæ EXPORT TEST RESULTS</button>
            <div id="statusResults"></div>
        </div>
    </div>

    <script>
        let testResults = {
            timestamp: new Date().toISOString(),
            tests: []
        };

        function logTest(testName, result, details) {
            testResults.tests.push({
                test: testName,
                result: result,
                details: details,
                timestamp: new Date().toISOString()
            });
        }

        function testDataPersistence() {
            const results = document.getElementById('persistenceResults');
            results.innerHTML = '<h3>üîÑ Testing Data Persistence...</h3>';
            
            // Test 1: Add test data
            const testNote = {
                id: 'bulletproof-test-' + Date.now(),
                title: 'BULLETPROOF TEST NOTE',
                content: 'This is a test note to verify bulletproof data protection works.',
                category: 'Development',
                tags: ['test', 'bulletproof'],
                created: new Date(),
                modified: new Date(),
                isPinned: false,
                isArchived: false,
                type: 'markdown'
            };

            // Save test data
            const existingNotes = JSON.parse(localStorage.getItem('nishen-workspace-notes') || '[]');
            existingNotes.push(testNote);
            localStorage.setItem('nishen-workspace-notes', JSON.stringify(existingNotes));
            
            results.innerHTML += '<div class="test-result pass">‚úÖ TEST 1: Test note added successfully</div>';
            logTest('Data Addition', 'PASS', 'Test note added to localStorage');

            // Test 2: Verify data exists
            const savedNotes = JSON.parse(localStorage.getItem('nishen-workspace-notes') || '[]');
            const foundNote = savedNotes.find(note => note.id === testNote.id);
            
            if (foundNote) {
                results.innerHTML += '<div class="test-result pass">‚úÖ TEST 2: Data persistence verified</div>';
                logTest('Data Persistence', 'PASS', 'Test note found after save');
            } else {
                results.innerHTML += '<div class="test-result fail">‚ùå TEST 2: Data persistence FAILED</div>';
                logTest('Data Persistence', 'FAIL', 'Test note not found after save');
            }

            // Test 3: Simulate page reload
            results.innerHTML += '<div class="test-result">üîÑ TEST 3: Simulating page reload in 3 seconds...</div>';
            setTimeout(() => {
                const afterReload = JSON.parse(localStorage.getItem('nishen-workspace-notes') || '[]');
                const stillExists = afterReload.find(note => note.id === testNote.id);
                
                if (stillExists) {
                    results.innerHTML += '<div class="test-result pass">‚úÖ TEST 3: Data survived simulated reload</div>';
                    logTest('Reload Persistence', 'PASS', 'Data persisted after reload simulation');
                } else {
                    results.innerHTML += '<div class="test-result fail">‚ùå TEST 3: Data lost during reload</div>';
                    logTest('Reload Persistence', 'FAIL', 'Data lost during reload simulation');
                }
            }, 3000);
        }

        function testMultipleReloads() {
            const results = document.getElementById('persistenceResults');
            results.innerHTML += '<h3>üîÑ Testing Multiple Reloads...</h3>';
            
            let reloadCount = 0;
            const maxReloads = 5;
            
            function performReloadTest() {
                reloadCount++;
                
                // Check if data still exists
                const notes = JSON.parse(localStorage.getItem('nishen-workspace-notes') || '[]');
                const testNotes = notes.filter(note => note.title.includes('BULLETPROOF TEST'));
                
                if (testNotes.length > 0) {
                    results.innerHTML += `<div class="test-result pass">‚úÖ RELOAD ${reloadCount}: Data intact (${testNotes.length} test notes)</div>`;
                    logTest(`Reload Test ${reloadCount}`, 'PASS', `${testNotes.length} test notes found`);
                } else {
                    results.innerHTML += `<div class="test-result fail">‚ùå RELOAD ${reloadCount}: Data lost</div>`;
                    logTest(`Reload Test ${reloadCount}`, 'FAIL', 'No test notes found');
                }
                
                if (reloadCount < maxReloads) {
                    setTimeout(performReloadTest, 1000);
                } else {
                    results.innerHTML += '<div class="test-result success">üéØ MULTIPLE RELOAD TEST COMPLETE</div>';
                }
            }
            
            performReloadTest();
        }

        function testStorageFailure() {
            const results = document.getElementById('persistenceResults');
            results.innerHTML += '<h3>üí• Testing Storage Failure Recovery...</h3>';
            
            // Simulate storage failure by trying to exceed quota
            try {
                const largeDummyData = 'x'.repeat(1000000); // 1MB of data
                for (let i = 0; i < 10; i++) {
                    localStorage.setItem(`dummy-${i}`, largeDummyData);
                }
                results.innerHTML += '<div class="test-result">‚ö†Ô∏è Storage stress test applied</div>';
            } catch (e) {
                results.innerHTML += '<div class="test-result">üí• Storage failure simulated: ' + e.message + '</div>';
            }
            
            // Test if our data still exists
            const notes = JSON.parse(localStorage.getItem('nishen-workspace-notes') || '[]');
            if (notes.length > 0) {
                results.innerHTML += '<div class="test-result pass">‚úÖ RECOVERY TEST: Core data survived storage stress</div>';
                logTest('Storage Failure Recovery', 'PASS', 'Data survived storage stress test');
            } else {
                results.innerHTML += '<div class="test-result fail">‚ùå RECOVERY TEST: Core data lost during storage failure</div>';
                logTest('Storage Failure Recovery', 'FAIL', 'Data lost during storage stress test');
            }
            
            // Clean up dummy data
            for (let i = 0; i < 10; i++) {
                localStorage.removeItem(`dummy-${i}`);
            }
        }

        function verifyBulletproofSystem() {
            const results = document.getElementById('bulletproofResults');
            results.innerHTML = '<h3>üõ°Ô∏è Verifying Bulletproof System...</h3>';
            
            // Check for bulletproof storage keys
            let bulletproofKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('BACKUP') || key.includes('REDUNDANT') || key.includes('EMERGENCY'))) {
                    bulletproofKeys.push(key);
                }
            }
            
            if (bulletproofKeys.length > 0) {
                results.innerHTML += `<div class="test-result pass">‚úÖ BULLETPROOF STORAGE: Found ${bulletproofKeys.length} backup layers</div>`;
                bulletproofKeys.forEach(key => {
                    results.innerHTML += `<div class="test-result">üì¶ Backup layer: ${key}</div>`;
                });
                logTest('Bulletproof Verification', 'PASS', `${bulletproofKeys.length} backup layers found`);
            } else {
                results.innerHTML += '<div class="test-result fail">‚ùå BULLETPROOF STORAGE: No backup layers found</div>';
                logTest('Bulletproof Verification', 'FAIL', 'No backup layers detected');
            }
            
            // Check session storage backup
            let sessionKeys = [];
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                if (key && key.includes('nishen-workspace')) {
                    sessionKeys.push(key);
                }
            }
            
            if (sessionKeys.length > 0) {
                results.innerHTML += `<div class="test-result pass">‚úÖ SESSION BACKUP: Found ${sessionKeys.length} session backups</div>`;
                logTest('Session Backup', 'PASS', `${sessionKeys.length} session backups found`);
            } else {
                results.innerHTML += '<div class="test-result">‚ö†Ô∏è SESSION BACKUP: No session backups found</div>';
                logTest('Session Backup', 'WARNING', 'No session backups detected');
            }
        }

        function testAutoBackup() {
            const results = document.getElementById('bulletproofResults');
            results.innerHTML += '<h3>‚è∞ Testing Auto-Backup System...</h3>';
            
            // Check if auto-backup is working by looking for recent backups
            const now = Date.now();
            let recentBackups = [];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.includes('BACKUP')) {
                    // Extract timestamp from key if possible
                    const timestampMatch = key.match(/(\d{13})/);
                    if (timestampMatch) {
                        const backupTime = parseInt(timestampMatch[1]);
                        const ageMinutes = (now - backupTime) / (1000 * 60);
                        if (ageMinutes < 10) { // Backups less than 10 minutes old
                            recentBackups.push({key, ageMinutes});
                        }
                    }
                }
            }
            
            if (recentBackups.length > 0) {
                results.innerHTML += `<div class="test-result pass">‚úÖ AUTO-BACKUP: Found ${recentBackups.length} recent backups</div>`;
                recentBackups.forEach(backup => {
                    results.innerHTML += `<div class="test-result">‚è∞ Backup: ${backup.key} (${backup.ageMinutes.toFixed(1)} min ago)</div>`;
                });
                logTest('Auto-Backup', 'PASS', `${recentBackups.length} recent backups found`);
            } else {
                results.innerHTML += '<div class="test-result">‚ö†Ô∏è AUTO-BACKUP: No recent backups found (may take time to initialize)</div>';
                logTest('Auto-Backup', 'WARNING', 'No recent backups detected');
            }
        }

        function testRecoveryLayers() {
            const results = document.getElementById('bulletproofResults');
            results.innerHTML += '<h3>üîß Testing Recovery Layers...</h3>';
            
            // Test each recovery method
            const recoveryTests = [
                {name: 'Primary Storage', key: 'nishen-workspace-notes'},
                {name: 'Backup Storage', key: 'nishen-workspace-notes_BACKUP'},
                {name: 'Redundant Storage', key: 'nishen-workspace-notes_REDUNDANT'},
                {name: 'Session Storage', key: 'nishen-workspace-notes_SESSION', storage: 'session'}
            ];
            
            recoveryTests.forEach(test => {
                const storage = test.storage === 'session' ? sessionStorage : localStorage;
                const data = storage.getItem(test.key);
                
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        const itemCount = Array.isArray(parsed) ? parsed.length : 'N/A';
                        results.innerHTML += `<div class="test-result pass">‚úÖ ${test.name}: Available (${itemCount} items)</div>`;
                        logTest(`Recovery Layer - ${test.name}`, 'PASS', `${itemCount} items available`);
                    } catch (e) {
                        results.innerHTML += `<div class="test-result">‚ö†Ô∏è ${test.name}: Available but unparseable</div>`;
                        logTest(`Recovery Layer - ${test.name}`, 'WARNING', 'Data exists but unparseable');
                    }
                } else {
                    results.innerHTML += `<div class="test-result">‚ùå ${test.name}: Not available</div>`;
                    logTest(`Recovery Layer - ${test.name}`, 'FAIL', 'No data found');
                }
            });
        }

        function getSystemStatus() {
            const results = document.getElementById('statusResults');
            results.innerHTML = '<h3>üìä System Status Report</h3>';
            
            // Storage usage
            let totalSize = 0;
            let workspaceSize = 0;
            let itemCount = 0;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const data = localStorage.getItem(key);
                if (data) {
                    totalSize += data.length;
                    if (key && key.includes('nishen-workspace')) {
                        workspaceSize += data.length;
                        itemCount++;
                    }
                }
            }
            
            results.innerHTML += `<div class="test-result">üìä Total localStorage: ${Math.round(totalSize/1024)} KB</div>`;
            results.innerHTML += `<div class="test-result">üìä Workspace data: ${Math.round(workspaceSize/1024)} KB (${itemCount} keys)</div>`;
            
            // Browser compatibility
            const features = {
                'localStorage': typeof(Storage) !== "undefined",
                'sessionStorage': typeof(sessionStorage) !== "undefined",
                'JSON': typeof(JSON) !== "undefined",
                'Date': typeof(Date) !== "undefined"
            };
            
            Object.keys(features).forEach(feature => {
                const status = features[feature] ? '‚úÖ' : '‚ùå';
                results.innerHTML += `<div class="test-result">${status} ${feature}: ${features[feature] ? 'Available' : 'Not available'}</div>`;
            });
            
            // Performance metrics
            const start = performance.now();
            const testData = JSON.stringify({test: 'performance', data: new Array(1000).fill('x')});
            localStorage.setItem('perf-test', testData);
            const saved = localStorage.getItem('perf-test');
            localStorage.removeItem('perf-test');
            const end = performance.now();
            
            results.innerHTML += `<div class="test-result">‚ö° Storage performance: ${(end - start).toFixed(2)}ms for 1KB test</div>`;
            
            logTest('System Status', 'COMPLETE', `${Math.round(workspaceSize/1024)} KB workspace data, ${(end - start).toFixed(2)}ms performance`);
        }

        function exportTestResults() {
            const blob = new Blob([JSON.stringify(testResults, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bulletproof-test-results-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            document.getElementById('statusResults').innerHTML += '<div class="test-result success">üíæ Test results exported successfully</div>';
        }

        // Auto-run system verification on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                getSystemStatus();
                verifyBulletproofSystem();
            }, 1000);
        });
    </script>
</body>
</html>